---
title: "Early Preeclampsia"
bibliography: rmasca.bib
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Early Preeclampsia}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  out.width = "100%", 
  fig.asp = 0.7,
  fig.width = 12,
  fig.align = "center"
)
df <- read.csv(file = "PE.csv", header = TRUE, sep = ";")
somaids <- read.csv(file = "somaids.csv", header = TRUE, sep = ";")
```

# Getting started

```{r setup}
library(RMASCA)
```

## Preparing the data

In this example we will look at data from @tarcaPredictionEarlyPreeclampsia2019. This is mostly a demonstration of the `RMASCA` package, and not a stringent scientific analysis.

The data looks like this

```{r}
head(df[,1:20])
```

So the columns from 11 and beyond are protein levels. We convert it to long format,

```{r}
df <- reshape2::melt(df, id.vars = colnames(df)[1:10])
```

RMASCA expects a data frame with at least the following columns (with these exact names)

* `time` Either factor, string or integer. Defines when a sample is taken.
* `variable` Either a factor or a string. The measured variable.
* `group` Either a factor, string or integer. Defines the group of a participant

The variable column is already okay. Let us define the time points;

```{r}
plot(df$GA[df$variable == "SL000318"])
```

All patients got their diagnosis before week 33.4, so let us limit ourselves to samples from before that and bulk the samples into

* Time 1: Before week 15
* Time 2: Week 15-22.5
* Time 3: Week 22.5-27.5
* Time 4: Week 27.5-33.4

```{r}
df <- subset(df, GA <= 33.4)
df$time <- ifelse(
              df$GA <= 15, 1,
              ifelse(
                df$GA <= 22.5, 2,
                ifelse(
                df$GA <= 27.5, 3,
                  4
                )
              )
            )
```

As for grouping, I decided to use

* Normal pregnancies (Normal)
* Early preeclampsia with maternal vascular malperfusion (PEV)
* Early preeclampsia withou maternal vascular malperfusion (PE)

```{r}
df$group <- ifelse(
              is.na(df$GADiagnosis), "Normal",
              ifelse(df$EarlyPE_MVU == 1, "PEV", "PE")
            )
```

In the paper, they identified the following important proteins (I'd to look up the somaIDs myself, so errors may have occurred)

* Matrix metalloproteinase-7 (also known as Matrilysin): SL000525
* Glycoprotein IIbIIIa complex (couldn't find ID)
* Placental growth factor (PlGF): SL002640
* Vascular endothelial growth factor A, isoform 121 (VEGF-121) (couldn't find ID)
* Sialic acid binding immunoglobulin-like lectin 6 (siglec-6): SL005217
* Activin-A (couldn't find ID)
* Leukocyte cell adhesion molecule (ALCAM): SL003166

In addition, I am interested in inflammatory proteins, so let us add interleukins and interferons, and eotaxin.

```{r}
df <- merge(df, somaids, by.x = "variable", by.y = "SomaId") # add protein names
selectedVariables <- c(which(df$variable %in% c("SL000525", "SL002640", "SL005217", "SL003166", "SL003104","SL000406")),
                       which(substr(df$Target,1,3) == "IL-"),
                       which(substr(df$Target,1,4) == "IFN-"))
df <- df[selectedVariables,]
df$variable <- factor(df$Target)
```

## Preparing the model

Now we can set up our model. Since it's an observational study, we can start with

```{r}
model.formula <- value ~ time*group + (1|ID)
```

# Running RMASCA

We are now ready to try `RMASCA`,

```{r}
PE.mod <- RMASCA(df, model.formula)
```

With a screeplot we can say something about how many components we need,

```{r}
screeplot(PE.mod)
```

It seems like three components should be enough.

```{r}
plot(PE.mod)
```

It's a bit crowded on the x-axis of the loadings, so we will only name the five with highest/lowest loading,

```{r}
plot(PE.mod, tooDense = 5)
plot(PE.mod, component = "PC2", tooDense = 5)
plot(PE.mod, component = "PC3", tooDense = 5)
plot(PE.mod, component = "PC4", effect = "group", tooDense = 5) # just to demonstrate how to extract only the group effect plot
```

We can also look up specific variables,

```{r}
plot(PE.mod, highlight = c("PlGF", "IL-6", "IL-1b", "IFN-g", "Eotaxin-2", "Eotaxin"))
```

Let us add some uncertainty estimates to our model. This may take some time.

```{r}
PE.mod <- validate(PE.mod, participantColumn = "ID")
plot(PE.mod, tooDense = 5)
plot(PE.mod, component = "PC2", tooDense = 5)
#plot(PE.mod, component = "PC3") # At the moment, we are only calculating uncertainty for component 1 and 2
```

# References