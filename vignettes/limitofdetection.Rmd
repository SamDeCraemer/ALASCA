---
title: "Limit of Detection"
author: "Anders H. Jarmund"
date: "`r Sys.Date()`"
bibliography: ALASCA.bib
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Limit of Detection}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  out.width = "100%", 
  fig.asp = 0.7,
  fig.width = 12,
  fig.align = "center",
  cache = FALSE,
  external = FALSE
)
postpartum <- haven::read_sav("postpartum.sav")
postpartum$id <- 1:nrow(postpartum)
for(i in 2:nrow(postpartum)){
  if(postpartum$mixed_model[i] == 3 & postpartum$mixed_model[i-1] == 4){
    postpartum$id[i] <- postpartum$id[i-1]
  }
}
df <- reshape2::melt(data = postpartum, id.vars = c("timepoint", "mixed_model", "id"))
df$variable <- gsub("_ALL","",df$variable)
df$variable <- gsub("im_[0-9][0-9][0-9]_","",df$variable, perl = TRUE)
df$time <- factor(ifelse(df$timepoint == 0, "Third trimester", "Postpartum"), levels = c("Third trimester", "Postpartum"))
df$group <- "controls"
df$ID <- factor(df$id)
```

# Limit of Detection

<script src="js/hideOutput.js"></script>
  <style>
  .showopt {
    background-color: #004c93;
      color: #FFFFFF; 
      width: 150px;
    height: 20px;
    text-align: center;
    vertical-align: middle !important;
    float: left;
    font-family: sans-serif;
    border-radius: 8px;
  }

.showopt:hover {
  background-color: #dfe4f2;
    color: #004c93;
}

.showopttext::before{
  content: "Show/Hide Source"
}

pre.plot {
  background-color: white !important;
}
</style>
  
```{r setup}
library("ggplot2")
library("ggpubr")
library("ALASCA")
```

In this vignette we will look at ways of dealing with limit of detection. We will use another pregnancy dataset with late third trimester and post-partum samples [@brann_emma_2019_1249367; @Brann2019]. Some of them are paired, but most are not. We can look at the paired observations (22 women):

```{r}
ggplot(subset(df, mixed_model > 2), aes(time, value, group = ID)) + geom_point() + geom_line() + facet_wrap(~variable, scales = 'free') + theme_bw()
```

Originally, the dataset contains only a few missing data points, so we will introduce some more by censoring all values below the 20th percentile by variable;

<div class="fold s">
```{r}
df0 <- na.omit(df) # keep original data but remove missing values
lowerLimit <- aggregate(data = df, value~variable, FUN = function(x){quantile(x, probs = .2, na.rm = TRUE)})
for(i in unique(df$variable)){
  df$value[df$value < lowerLimit$value[lowerLimit$variable == i] & df$variable == i] <- NA
}
df$value[is.na(df$value)] <- 0
```
</div>

Note the peak about zero where we have put the censored measurements:

```{r}
ggplot(df, aes(value, fill = time)) +
  geom_density(alpha = .5) +
  facet_wrap(~variable, scales = 'free') +
  theme_bw()
```

## Replacement

A common yet limited way of dealing with the censored observations is replacing them with half the lower limit of detection.

<div class="fold s">
```{r}
df_half <- df
for(i in unique(df_half$variable)){
  df_half$value[df_half$value == 0 & df_half$variable == i] <- lowerLimit$value[lowerLimit$variable == i]/2
}
```
</div>

We have now replaced the zero values, but you can still see that we have a peak corresponding to the lower values.

```{r}
ggplot(df_half, aes(value, fill = time)) +
  geom_density(alpha = .5) +
  facet_wrap(~variable, scales = 'free') +
  theme_bw()
```

```{r}
scaleFun <- function(x){return(x)}
mod.orig <- ALASCA(df0,
              value ~ time + (1|ID),
              separateTimeAndGroup = FALSE,
              useRfast = TRUE,
              scaleFun = scaleFun,
              method = "LMM")
mod.half <- ALASCA(df_half,
              value ~ time + (1|ID),
              separateTimeAndGroup = FALSE,
              useRfast = TRUE,
              scaleFun = scaleFun,
              method = "LMM")
mod.KMM <- ALASCA(df,
              value ~ time,
              separateTimeAndGroup = FALSE,
              useRfast = FALSE,
              lowerLimit = lowerLimit,
              scaleFun = scaleFun,
              method = "KMM")
```

We note that PDL1 and LIFR was excluded by the authors due to the large number of undetectable measurements [@Brann2019]. The Cox regression seems to overestimate the decrease of these variables (or - the ordinary ASCA is underestimating the decrease)

```{r}
ggarrange(
    plot(flipIt(mod.orig)),
    plot(flipIt(mod.half)),
    plot(flipIt(mod.KMM)),
    nrow = 3, ncol = 1
)
```